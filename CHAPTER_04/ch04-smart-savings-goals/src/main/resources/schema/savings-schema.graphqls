# ==============================================================================
# CAPÃTULO 4: SMART SAVINGS GOALS - GRAPHQL + JPA + POSTGRESQL
# ==============================================================================
#
# ğŸ¯ TEMA: Persistencia de datos con JPA y transacciones en GraphQL
#
# Este capÃ­tulo introduce:
# - IntegraciÃ³n de Netflix DGS con Spring Data JPA
# - Entidades JPA mapeadas a PostgreSQL
# - Transacciones atÃ³micas con @Transactional
# - Campos calculados (progressPercentage)
# - PatrÃ³n de respuesta estructurada (success/message/data)
#
# ==============================================================================
# MAPEO COMPLETO: SCHEMA GRAPHQL â†” CLASES JAVA
# ==============================================================================
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  SCHEMA GRAPHQL              â”‚  IMPLEMENTACIÃ“N JAVA                       â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  scalar Money                â”‚  java.math.BigDecimal (MoneyScalar.java)   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  enum GoalStatus             â”‚  SavingsGoalEntity.GoalStatus (inner enum) â”‚
# â”‚  enum GoalCategory           â”‚  SavingsGoalEntity.GoalCategory (inner)    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  type SavingsGoal            â”‚  SavingsGoalEntity.java â†’ Map<String,Obj>  â”‚
# â”‚  type SavingsGoalResponse    â”‚  Map<String, Object> en Resolver           â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  input CreateSavingsGoalInputâ”‚  Map<String, Object> en Resolver           â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  Query.savingsGoal           â”‚  SavingsGoalResolver.savingsGoal()         â”‚
# â”‚  Query.savingsGoals          â”‚  SavingsGoalResolver.savingsGoals()        â”‚
# â”‚  Query.activeSavingsGoals    â”‚  SavingsGoalResolver.activeSavingsGoals()  â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚  Mutation.createSavingsGoal  â”‚  SavingsGoalResolver.createSavingsGoal()   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ==============================================================================
# ğŸ”¥ TEMA CENTRAL: PERSISTENCIA CON JPA
# ==============================================================================
#
# ARQUITECTURA DE CAPAS:
# ```
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  GraphQL Schema â”‚  â† Contrato API (este archivo)
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚    Resolver     â”‚  â† SavingsGoalResolver.java (@DgsComponent)
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚    Service      â”‚  â† SavingsGoalService.java (@Transactional)
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚   Repository    â”‚  â† SavingsGoalRepository.java (Spring Data JPA)
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#          â”‚
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚   PostgreSQL    â”‚  â† Tabla: savings_goals
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# ```
#
# ==============================================================================


# ==============================================================================
# CUSTOM SCALAR
# ==============================================================================
#
# ğŸ“ SECCIÃ“N 4.2: Scalar para valores monetarios
#
# IMPLEMENTACIÃ“N: scalar/MoneyScalar.java
# ```java
# @DgsScalar(name = "Money")
# public class MoneyScalar implements Coercing<BigDecimal, String> {
#     @Override
#     public String serialize(Object dataFetcherResult) {
#         return ((BigDecimal) dataFetcherResult).toPlainString();
#     }
#     
#     @Override
#     public BigDecimal parseValue(Object input) {
#         return new BigDecimal(input.toString());
#     }
# }
# ```
#
# ğŸ’¡ Â¿POR QUÃ‰ BIGDECIMAL PARA DINERO?
# ```java
# double d = 0.1 + 0.2;  // = 0.30000000000000004 âŒ
# BigDecimal b = new BigDecimal("0.1").add(new BigDecimal("0.2"));  // = 0.3 âœ…
# ```
# ==============================================================================

"Valor monetario con precisiÃ³n decimal â†’ java.math.BigDecimal"
scalar Money


# ==============================================================================
# ENUMS
# ==============================================================================

"""
Estados posibles de una meta de ahorro.

IMPLEMENTACIÃ“N JAVA: SavingsGoalEntity.GoalStatus (inner enum)
```java
public enum GoalStatus {
    ACTIVE,     // Meta activa, aceptando depÃ³sitos
    PAUSED,     // Meta pausada temporalmente
    COMPLETED,  // Meta completada (currentAmount >= targetAmount)
    CANCELLED   // Meta cancelada por el usuario
}
```

CICLO DE VIDA:
```
ACTIVE â†’ COMPLETED (al alcanzar targetAmount)
       â†’ PAUSED (usuario pausa temporalmente)
       â†’ CANCELLED (usuario cancela)
```

VALIDACIÃ“N EN SERVICE:
```java
// SavingsGoalService.deposit()
if (goal.getStatus() != GoalStatus.ACTIVE) {
    throw new IllegalStateException("Cannot deposit to a " + goal.getStatus() + " goal");
}
```
"""
enum GoalStatus {
    "Meta activa, aceptando depÃ³sitos"
    ACTIVE
    
    "Meta pausada temporalmente por el usuario"
    PAUSED
    
    "Meta completada (currentAmount >= targetAmount)"
    COMPLETED
    
    "Meta cancelada por el usuario"
    CANCELLED
}

"""
CategorÃ­as de metas de ahorro.

IMPLEMENTACIÃ“N JAVA: SavingsGoalEntity.GoalCategory (inner enum)
```java
public enum GoalCategory {
    EMERGENCY_FUND,  // Fondo de emergencia (3-6 meses de gastos)
    VACATION,        // Vacaciones y viajes
    HOME_PURCHASE,   // Enganche para casa
    EDUCATION,       // Universidad, cursos, certificaciones
    RETIREMENT,      // Ahorro para retiro
    INVESTMENT,      // Capital para inversiones
    OTHER            // Otras metas
}
```

ğŸ’¡ USO EN NEGOCIO:
- Permite organizar y filtrar metas
- Potencialmente aplicar reglas diferentes por categorÃ­a
- Analytics: "Â¿CuÃ¡nto ahorran los usuarios para vacaciones vs emergencia?"
"""
enum GoalCategory {
    "Fondo de emergencia (3-6 meses de gastos)"
    EMERGENCY_FUND
    
    "Vacaciones y viajes"
    VACATION
    
    "Enganche para casa"
    HOME_PURCHASE
    
    "EducaciÃ³n (universidad, cursos, certificaciones)"
    EDUCATION
    
    "Ahorro para retiro"
    RETIREMENT
    
    "Capital para inversiones"
    INVESTMENT
    
    "Otras metas personales"
    OTHER
}


# ==============================================================================
# DOMAIN TYPES
# ==============================================================================

"""
Meta de ahorro de un usuario.

ğŸ“ SECCIÃ“N 4.2: ENTIDAD JPA

IMPLEMENTACIÃ“N JAVA: model/SavingsGoalEntity.java
```java
@Entity
@Table(name = "savings_goals")
public class SavingsGoalEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long goalId;
    
    @Column(nullable = false)
    private Long userId;
    
    @Column(nullable = false)
    private String name;
    
    private String description;
    
    @Column(nullable = false, precision = 15, scale = 2)
    private BigDecimal targetAmount;
    
    @Column(nullable = false, precision = 15, scale = 2)
    private BigDecimal currentAmount = BigDecimal.ZERO;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private GoalCategory category;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private GoalStatus status = GoalStatus.ACTIVE;
}
```

MAPEO A POSTGRESQL:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Clase Java                    Tabla PostgreSQL            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  SavingsGoalEntity      â†’      savings_goals               â”‚
â”‚  goalId (Long)          â†’      goal_id (BIGSERIAL PK)      â”‚
â”‚  userId (Long)          â†’      user_id (BIGINT NOT NULL)   â”‚
â”‚  name (String)          â†’      name (VARCHAR NOT NULL)     â”‚
â”‚  description (String)   â†’      description (VARCHAR)       â”‚
â”‚  targetAmount (BigDec)  â†’      target_amount (NUMERIC)     â”‚
â”‚  currentAmount (BigDec) â†’      current_amount (NUMERIC)    â”‚
â”‚  category (Enum)        â†’      category (VARCHAR)          â”‚
â”‚  status (Enum)          â†’      status (VARCHAR)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âš ï¸ TRANSFORMACIÃ“N ENTITY â†’ GRAPHQL:
El resolver transforma la entidad a Map porque los nombres difieren:
```java
// SavingsGoalResolver.toGraphQL()
private Map<String, Object> toGraphQL(SavingsGoalEntity entity) {
    Map<String, Object> map = new HashMap<>();
    map.put("id", entity.getGoalId().toString());  // goalId â†’ id
    map.put("userId", entity.getUserId().toString());
    map.put("name", entity.getName());
    map.put("description", entity.getDescription());
    map.put("targetAmount", entity.getTargetAmount());
    map.put("currentAmount", entity.getCurrentAmount());
    map.put("category", entity.getCategory().name());
    map.put("status", entity.getStatus().name());
    map.put("progressPercentage", calculateProgress(entity));  // CALCULADO
    return map;
}
```
"""
type SavingsGoal {
    "ID Ãºnico de la meta (goalId en Entity)"
    id: ID!
    
    "ID del usuario propietario"
    userId: ID!
    
    "Nombre descriptivo (ej: 'Vacaciones a JapÃ³n')"
    name: String!
    
    "DescripciÃ³n detallada opcional"
    description: String
    
    "Monto objetivo a alcanzar"
    targetAmount: Money!
    
    "Monto actualmente ahorrado"
    currentAmount: Money!
    
    "CategorÃ­a de la meta"
    category: GoalCategory!
    
    "Estado actual de la meta"
    status: GoalStatus!
    
    """
    ğŸ”¥ CAMPO CALCULADO - NO ESTÃ EN BASE DE DATOS
    
    Se calcula en el resolver cada vez que se consulta:
    ```java
    private double calculateProgress(SavingsGoalEntity entity) {
        if (entity.getTargetAmount().compareTo(BigDecimal.ZERO) == 0) {
            return 0.0;
        }
        return entity.getCurrentAmount()
            .divide(entity.getTargetAmount(), 4, RoundingMode.HALF_UP)
            .multiply(BigDecimal.valueOf(100))
            .doubleValue();
    }
    ```
    
    FÃ“RMULA: (currentAmount / targetAmount) Ã— 100
    RANGO: 0.0 a 100.0+ (puede exceder 100 si se deposita de mÃ¡s)
    """
    progressPercentage: Float!
}

"""
Respuesta estructurada para mutations.

ğŸ“ SECCIÃ“N 4.5: MANEJO DE ERRORES

En vez de lanzar excepciones GraphQL, usamos un patrÃ³n de respuesta
estructurada que permite al cliente manejar errores de forma predecible.

IMPLEMENTACIÃ“N JAVA: Map<String, Object> en SavingsGoalResolver
```java
@DgsMutation
public Map<String, Object> createSavingsGoal(@InputArgument Map<String, Object> input) {
    try {
        SavingsGoalEntity saved = service.createGoal(entity);
        
        Map<String, Object> response = new HashMap<>();
        response.put("success", true);
        response.put("message", "Goal created successfully");
        response.put("goal", toGraphQL(saved));
        return response;
        
    } catch (Exception e) {
        Map<String, Object> response = new HashMap<>();
        response.put("success", false);
        response.put("message", "Error: " + e.getMessage());
        response.put("goal", null);
        return response;
    }
}
```

ğŸ’¡ VENTAJAS DE ESTE PATRÃ“N:
- El cliente siempre recibe HTTP 200
- Puede distinguir errores de negocio vs errores tÃ©cnicos
- FÃ¡cil de procesar en el frontend
"""
type SavingsGoalResponse {
    "Â¿La operaciÃ³n fue exitosa?"
    success: Boolean!
    
    "Mensaje descriptivo (Ã©xito o error)"
    message: String!
    
    "Meta creada/actualizada (null si hubo error)"
    goal: SavingsGoal
}


# ==============================================================================
# INPUT TYPES
# ==============================================================================

"""
Input para crear una nueva meta de ahorro.

IMPLEMENTACIÃ“N JAVA: Map<String, Object> en SavingsGoalResolver
```java
@DgsMutation
public Map<String, Object> createSavingsGoal(@InputArgument Map<String, Object> input) {
    SavingsGoalEntity entity = SavingsGoalEntity.builder()
        .userId(Long.parseLong(input.get("userId").toString()))
        .name(input.get("name").toString())
        .description(input.get("description") != null 
                     ? input.get("description").toString() 
                     : null)
        .targetAmount(new BigDecimal(input.get("targetAmount").toString()))
        .category(SavingsGoalEntity.GoalCategory.valueOf(
                  input.get("category").toString()))
        .build();
    
    SavingsGoalEntity saved = service.createGoal(entity);
    // ...
}
```

VALIDACIONES EN SERVICE:
```java
private void validateGoal(SavingsGoalEntity goal) {
    if (goal.getName() == null || goal.getName().trim().isEmpty()) {
        throw new IllegalArgumentException("Goal name is required");
    }
    if (goal.getTargetAmount() == null || 
        goal.getTargetAmount().compareTo(BigDecimal.ZERO) <= 0) {
        throw new IllegalArgumentException("Target amount must be positive");
    }
    if (goal.getUserId() == null) {
        throw new IllegalArgumentException("User ID is required");
    }
    if (goal.getCategory() == null) {
        throw new IllegalArgumentException("Category is required");
    }
}
```
"""
input CreateSavingsGoalInput {
    "ID del usuario que crea la meta"
    userId: ID!
    
    "Nombre de la meta (ej: 'Vacaciones 2025')"
    name: String!
    
    "DescripciÃ³n opcional"
    description: String
    
    "Monto objetivo (debe ser positivo)"
    targetAmount: Float!
    
    "CategorÃ­a de la meta"
    category: GoalCategory!
}


# ==============================================================================
# QUERIES
# ==============================================================================
#
# ğŸ“ SECCIÃ“N 4.1: INTEGRACIÃ“N JPA CON GRAPHQL
#
# IMPLEMENTACIÃ“N: resolver/SavingsGoalResolver.java
# ```java
# @DgsComponent
# public class SavingsGoalResolver {
#     private final SavingsGoalService service;
#     
#     @DgsQuery
#     public Map<String, Object> savingsGoal(@InputArgument String id) {
#         SavingsGoalEntity entity = service.getGoalById(Long.parseLong(id));
#         return toGraphQL(entity);
#     }
# }
# ```
# ==============================================================================

type Query {
    
    """
    Obtener una meta de ahorro por ID.
    
    JAVA: SavingsGoalResolver.savingsGoal()
    ```java
    @DgsQuery
    public Map<String, Object> savingsGoal(@InputArgument String id) {
        SavingsGoalEntity entity = service.getGoalById(Long.parseLong(id));
        return toGraphQL(entity);
    }
    ```
    
    SERVICE: SavingsGoalService.getGoalById()
    ```java
    public SavingsGoalEntity getGoalById(Long goalId) {
        return repository.findById(goalId)
            .orElseThrow(() -> new RuntimeException("Goal not found: " + goalId));
    }
    ```
    
    ğŸ’¡ EJEMPLO:
    ```graphql
    query {
      savingsGoal(id: "1") {
        name
        targetAmount
        currentAmount
        progressPercentage
        status
      }
    }
    ```
    """
    savingsGoal(id: ID!): SavingsGoal
    
    """
    Obtener todas las metas de un usuario.
    
    JAVA: SavingsGoalResolver.savingsGoals()
    ```java
    @DgsQuery
    public List<Map<String, Object>> savingsGoals(@InputArgument String userId) {
        return service.getGoalsByUserId(Long.parseLong(userId)).stream()
            .map(this::toGraphQL)
            .collect(Collectors.toList());
    }
    ```
    
    REPOSITORY: SavingsGoalRepository
    ```java
    public interface SavingsGoalRepository extends JpaRepository<SavingsGoalEntity, Long> {
        List<SavingsGoalEntity> findByUserId(Long userId);
    }
    ```
    
    ğŸ’¡ EJEMPLO:
    ```graphql
    query {
      savingsGoals(userId: "1") {
        id
        name
        progressPercentage
        status
      }
    }
    ```
    """
    savingsGoals(userId: ID!): [SavingsGoal!]!
    
    """
    Obtener solo las metas ACTIVAS de un usuario.
    
    JAVA: SavingsGoalResolver.activeSavingsGoals()
    ```java
    @DgsQuery
    public List<Map<String, Object>> activeSavingsGoals(@InputArgument String userId) {
        return service.getActiveGoalsByUserId(Long.parseLong(userId)).stream()
            .map(this::toGraphQL)
            .collect(Collectors.toList());
    }
    ```
    
    REPOSITORY: Query method derivado
    ```java
    List<SavingsGoalEntity> findByUserIdAndStatus(Long userId, GoalStatus status);
    ```
    
    SERVICE:
    ```java
    public List<SavingsGoalEntity> getActiveGoalsByUserId(Long userId) {
        return repository.findByUserIdAndStatus(userId, GoalStatus.ACTIVE);
    }
    ```
    
    ğŸ’¡ EJEMPLO:
    ```graphql
    query {
      activeSavingsGoals(userId: "1") {
        name
        progressPercentage
      }
    }
    ```
    """
    activeSavingsGoals(userId: ID!): [SavingsGoal!]!
}


# ==============================================================================
# MUTATIONS
# ==============================================================================
#
# ğŸ“ SECCIÃ“N 4.3: TRANSACCIONES EN MUTATIONS
#
# Las mutations que modifican datos usan @Transactional para garantizar
# atomicidad. Si algo falla, se hace ROLLBACK automÃ¡tico.
#
# ```java
# @Service
# public class SavingsGoalService {
#     
#     @Transactional
#     public SavingsGoalEntity createGoal(SavingsGoalEntity goal) {
#         validateGoal(goal);
#         goal.setStatus(GoalStatus.ACTIVE);
#         goal.setCurrentAmount(BigDecimal.ZERO);
#         return repository.save(goal);
#     }
# }
# ```
# ==============================================================================

type Mutation {
    
    """
    Crear una nueva meta de ahorro.
    
    ğŸ“ SECCIÃ“N 4.3 + 4.5: TRANSACCIONES Y MANEJO DE ERRORES
    
    JAVA: SavingsGoalResolver.createSavingsGoal()
    ```java
    @DgsMutation
    public Map<String, Object> createSavingsGoal(@InputArgument Map<String, Object> input) {
        try {
            SavingsGoalEntity entity = SavingsGoalEntity.builder()
                .userId(Long.parseLong(input.get("userId").toString()))
                .name(input.get("name").toString())
                .description(input.get("description") != null 
                             ? input.get("description").toString() : null)
                .targetAmount(new BigDecimal(input.get("targetAmount").toString()))
                .category(GoalCategory.valueOf(input.get("category").toString()))
                .build();
            
            SavingsGoalEntity saved = service.createGoal(entity);
            
            return Map.of(
                "success", true,
                "message", "Goal created successfully",
                "goal", toGraphQL(saved)
            );
            
        } catch (Exception e) {
            return Map.of(
                "success", false,
                "message", "Error: " + e.getMessage(),
                "goal", null
            );
        }
    }
    ```
    
    SERVICE CON @TRANSACTIONAL:
    ```java
    @Transactional
    public SavingsGoalEntity createGoal(SavingsGoalEntity goal) {
        validateGoal(goal);
        goal.setStatus(GoalStatus.ACTIVE);
        if (goal.getCurrentAmount() == null) {
            goal.setCurrentAmount(BigDecimal.ZERO);
        }
        return repository.save(goal);
    }
    ```
    
    ğŸ’¡ EJEMPLO:
    ```graphql
    mutation {
      createSavingsGoal(input: {
        userId: "1"
        name: "Vacaciones 2025"
        description: "Viaje a Europa"
        targetAmount: 5000.00
        category: VACATION
      }) {
        success
        message
        goal {
          id
          name
          progressPercentage
        }
      }
    }
    ```
    
    RESPUESTA EXITOSA:
    ```json
    {
      "data": {
        "createSavingsGoal": {
          "success": true,
          "message": "Goal created successfully",
          "goal": {
            "id": "5",
            "name": "Vacaciones 2025",
            "progressPercentage": 0.0
          }
        }
      }
    }
    ```
    
    RESPUESTA CON ERROR:
    ```json
    {
      "data": {
        "createSavingsGoal": {
          "success": false,
          "message": "Error: Target amount must be positive",
          "goal": null
        }
      }
    }
    ```
    """
    createSavingsGoal(input: CreateSavingsGoalInput!): SavingsGoalResponse!
}


# ==============================================================================
# OPERACIONES ADICIONALES EN SERVICE (NO EXPUESTAS EN GRAPHQL AÃšN)
# ==============================================================================
#
# El SavingsGoalService tiene mÃ¡s operaciones que podrÃ­an exponerse:
#
# ğŸ”¹ DEPOSIT (depositar dinero en una meta):
# ```java
# @Transactional
# public SavingsGoalEntity deposit(Long goalId, BigDecimal amount) {
#     if (amount.compareTo(BigDecimal.ZERO) <= 0) {
#         throw new IllegalArgumentException("Deposit amount must be positive");
#     }
#     
#     SavingsGoalEntity goal = getGoalById(goalId);
#     
#     if (goal.getStatus() != GoalStatus.ACTIVE) {
#         throw new IllegalStateException("Cannot deposit to a " + goal.getStatus() + " goal");
#     }
#     
#     goal.setCurrentAmount(goal.getCurrentAmount().add(amount));
#     
#     // Auto-completar si se alcanza la meta
#     if (goal.isCompleted()) {
#         goal.setStatus(GoalStatus.COMPLETED);
#     }
#     
#     return repository.save(goal);
# }
# ```
#
# ğŸ”¹ WITHDRAW (retirar dinero de una meta):
# ```java
# @Transactional
# public SavingsGoalEntity withdraw(Long goalId, BigDecimal amount) {
#     SavingsGoalEntity goal = getGoalById(goalId);
#     
#     if (goal.getCurrentAmount().compareTo(amount) < 0) {
#         throw new IllegalStateException("Insufficient balance");
#     }
#     
#     goal.setCurrentAmount(goal.getCurrentAmount().subtract(amount));
#     return repository.save(goal);
# }
# ```
#
# ğŸ”¹ UPDATE STATUS (pausar, cancelar, etc.):
# ```java
# @Transactional
# public SavingsGoalEntity updateStatus(Long goalId, GoalStatus newStatus) {
#     SavingsGoalEntity goal = getGoalById(goalId);
#     goal.setStatus(newStatus);
#     return repository.save(goal);
# }
# ```
#
# ğŸ’¡ EJERCICIO PARA EL ALUMNO:
# Exponer estas operaciones como Mutations GraphQL adicionales.
#
# ==============================================================================


# ==============================================================================
# RESUMEN: ARCHIVOS JAVA DEL CAPÃTULO 4
# ==============================================================================
#
# ğŸ“¦ MODEL (model/):
# â””â”€â”€ SavingsGoalEntity.java       â†’ @Entity JPA con GoalStatus y GoalCategory
#
# ğŸ“¦ REPOSITORY (repository/):
# â””â”€â”€ SavingsGoalRepository.java   â†’ JpaRepository<SavingsGoalEntity, Long>
#                                    findByUserId(), findByUserIdAndStatus()
#
# ğŸ“¦ SERVICE (service/):
# â””â”€â”€ SavingsGoalService.java      â†’ LÃ³gica de negocio + @Transactional
#                                    getGoalById(), createGoal(), deposit(), etc.
#
# ğŸ“¦ RESOLVER (resolver/):
# â””â”€â”€ SavingsGoalResolver.java     â†’ @DgsComponent con @DgsQuery y @DgsMutation
#                                    Transforma Entity â†’ Map para GraphQL
#
# ğŸ“¦ SCALAR (scalar/):
# â””â”€â”€ MoneyScalar.java             â†’ @DgsScalar para BigDecimal â†” Money
#
# ğŸ“¦ RESOURCES:
# â”œâ”€â”€ schema/savings-schema.graphqls  â† Este archivo
# â”œâ”€â”€ application.yml                 â† Config PostgreSQL + DGS
# â””â”€â”€ data.sql                        â† Datos iniciales
#
# ğŸ“¦ DOCKER:
# â””â”€â”€ docker-compose.yml           â†’ PostgreSQL containerizado
#
# ==============================================================================
#
# ğŸ¯ ANOTACIONES CLAVE DEL CAPÃTULO:
#
# JPA:
# @Entity           â†’ Marca clase como entidad persistente
# @Table            â†’ Nombre de la tabla en BD
# @Id               â†’ Campo de clave primaria
# @GeneratedValue   â†’ Auto-generaciÃ³n de ID
# @Column           â†’ ConfiguraciÃ³n de columna
# @Enumerated       â†’ CÃ³mo persistir enums (STRING recomendado)
#
# SPRING:
# @Service          â†’ Componente de lÃ³gica de negocio
# @Transactional    â†’ OperaciÃ³n atÃ³mica (rollback si falla)
# @Repository       â†’ Componente de acceso a datos
#
# DGS:
# @DgsComponent     â†’ Componente DGS (resolver)
# @DgsQuery         â†’ MÃ©todo resuelve una Query
# @DgsMutation      â†’ MÃ©todo resuelve una Mutation
# @DgsScalar        â†’ Scalar personalizado
# @InputArgument    â†’ Inyecta argumento de la query/mutation
#
# ==============================================================================
