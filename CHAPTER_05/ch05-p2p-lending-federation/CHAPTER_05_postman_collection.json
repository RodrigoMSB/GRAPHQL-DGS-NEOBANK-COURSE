{
  "info": {
    "_postman_id": "ch05-federation-p2p-lending",
    "name": "CHAPTER 05: Apollo Federation - P2P Lending",
    "description": "Complete test suite for Chapter 05 - Federation with Netflix DGS and Apollo\n\n**Architecture:**\n- Users Service (Port 8081) - Owner of User entity\n- Loans Service (Port 8082) - Extends User, owns Loan entity\n\n**Covers:**\n- Section 5.1: Federated architecture concepts\n- Section 5.2: @key, @extends, @external directives\n- Section 5.3: Subgraph creation with DGS\n- Section 5.4: Ownership and governance\n\n**Total: 15 tests** (Users: 7, Loans: 8)\n\n**Prerequisites:**\n1. Users Service running: `cd users-service && mvn spring-boot:run`\n2. Loans Service running: `cd loans-service && mvn spring-boot:run`\n\n**Note:** Tests run against standalone subgraphs. With Apollo Router, queries would be unified at port 8080.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Users Service (Port 8081)",
      "item": [
        {
          "name": "1. Get Single User",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"User data is present\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.user).to.exist;",
                  "    pm.expect(jsonData.data.user.id).to.eql('user-001');",
                  "});",
                  "",
                  "pm.test(\"User has all fields\", function () {",
                  "    var user = pm.response.json().data.user;",
                  "    pm.expect(user).to.have.property('email');",
                  "    pm.expect(user).to.have.property('fullName');",
                  "    pm.expect(user).to.have.property('userType');",
                  "    pm.expect(user).to.have.property('reputation');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  user(id: \"user-001\") {\n    id\n    email\n    fullName\n    userType\n    reputation\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "**Federation Concept: @key entity**\n\nUser is marked with @key(fields: \"id\"), making it a federated entity.\n\nThis test validates the base User entity from its owner subgraph."
          },
          "response": []
        },
        {
          "name": "2. Get All Users",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Users list is not empty\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.users).to.be.an('array');",
                  "    pm.expect(jsonData.data.users.length).to.be.above(0);",
                  "});",
                  "",
                  "pm.test(\"Users have correct types\", function () {",
                  "    var users = pm.response.json().data.users;",
                  "    users.forEach(user => {",
                  "        pm.expect(['LENDER', 'BORROWER', 'BOTH']).to.include(user.userType);",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  users {\n    id\n    fullName\n    userType\n    reputation\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "Query all users from the Users subgraph.\n\nExpected: 5 users (lenders, borrowers, and both)"
          },
          "response": []
        },
        {
          "name": "3. Get Verified Lenders",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"All users are verified lenders\", function () {",
                  "    var lenders = pm.response.json().data.verifiedLenders;",
                  "    lenders.forEach(lender => {",
                  "        pm.expect(lender.lenderProfile).to.exist;",
                  "        pm.expect(lender.lenderProfile.verified).to.be.true;",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  verifiedLenders {\n    id\n    fullName\n    lenderProfile {\n      totalLent\n      activeLoans\n      averageReturn\n      riskTolerance\n      verified\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "**Domain Ownership**\n\nLenderProfile is owned by Users service.\n\nThis demonstrates clear domain boundaries."
          },
          "response": []
        },
        {
          "name": "4. Get Verified Borrowers",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"All users are verified borrowers\", function () {",
                  "    var borrowers = pm.response.json().data.verifiedBorrowers;",
                  "    borrowers.forEach(borrower => {",
                  "        pm.expect(borrower.borrowerProfile).to.exist;",
                  "        pm.expect(borrower.borrowerProfile.verified).to.be.true;",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  verifiedBorrowers {\n    id\n    fullName\n    borrowerProfile {\n      creditScore\n      totalBorrowed\n      activeLoans\n      defaultRate\n      kycStatus\n      verified\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "Query borrowers with their credit profiles.\n\nBorrowerProfile is part of Users domain."
          },
          "response": []
        },
        {
          "name": "5. Get User with Both Profiles",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"User has both profiles\", function () {",
                  "    var user = pm.response.json().data.user;",
                  "    pm.expect(user.lenderProfile).to.exist;",
                  "    pm.expect(user.borrowerProfile).to.exist;",
                  "    pm.expect(user.userType).to.eql('BOTH');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  user(id: \"user-005\") {\n    id\n    fullName\n    userType\n    lenderProfile {\n      totalLent\n      verified\n    }\n    borrowerProfile {\n      creditScore\n      verified\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "User that acts as both lender and borrower.\n\nExpected: user-005 (Emily Watson)"
          },
          "response": []
        },
        {
          "name": "6. Create New User (Mutation)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Mutation was successful\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.createUser.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"User was created\", function () {",
                  "    var response = pm.response.json().data.createUser;",
                  "    pm.expect(response.user).to.exist;",
                  "    pm.expect(response.user.email).to.eql('newuser@neobank.com');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "mutation {\n  createUser(input: {\n    email: \"newuser@neobank.com\"\n    fullName: \"New Test User\"\n    userType: BORROWER\n  }) {\n    success\n    message\n    user {\n      id\n      email\n      fullName\n      userType\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "Create a new user in the Users service.\n\nDemonstrates mutations in federated subgraphs."
          },
          "response": []
        },
        {
          "name": "7. Introspection - User Type",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"User type exists\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.__type.name).to.eql('User');",
                  "});",
                  "",
                  "pm.test(\"User has federation directives\", function () {",
                  "    var type = pm.response.json().data.__type;",
                  "    pm.expect(type.fields).to.be.an('array');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  __type(name: \"User\") {\n    name\n    fields {\n      name\n      type {\n        name\n        kind\n      }\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{USERS_SERVICE}}",
              "host": [
                "{{USERS_SERVICE}}"
              ]
            },
            "description": "**Introspection Query**\n\nExplore the User type definition in the Users subgraph schema."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Loans Service (Port 8082)",
      "item": [
        {
          "name": "8. Get Single Loan",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Loan data is present\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.loan).to.exist;",
                  "    pm.expect(jsonData.data.loan.id).to.eql('loan-001');",
                  "});",
                  "",
                  "pm.test(\"Loan has financial data\", function () {",
                  "    var loan = pm.response.json().data.loan;",
                  "    pm.expect(loan.amount).to.be.above(0);",
                  "    pm.expect(loan.interestRate).to.be.above(0);",
                  "    pm.expect(loan.monthlyPayment).to.be.above(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  loan(id: \"loan-001\") {\n    id\n    amount\n    interestRate\n    term\n    status\n    purpose\n    monthlyPayment\n    totalRepayment\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "**Loans Domain**\n\nQuery a single loan from the Loans subgraph.\n\nLoan is owned by this service."
          },
          "response": []
        },
        {
          "name": "9. Get All Loans",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Loans list is not empty\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.loans).to.be.an('array');",
                  "    pm.expect(jsonData.data.loans.length).to.be.above(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  loans {\n    id\n    amount\n    status\n    purpose\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "Query all loans.\n\nExpected: 5 loans with different statuses"
          },
          "response": []
        },
        {
          "name": "10. Get Available Loans (PENDING)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"All loans are PENDING\", function () {",
                  "    var loans = pm.response.json().data.availableLoans;",
                  "    loans.forEach(loan => {",
                  "        pm.expect(loan.status).to.eql('PENDING');",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  availableLoans {\n    id\n    amount\n    interestRate\n    term\n    purpose\n    status\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "Query loans available for funding (PENDING status).\n\nExpected: 2-3 pending loans"
          },
          "response": []
        },
        {
          "name": "11. Get Loans by Status (ACTIVE)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"All loans are ACTIVE\", function () {",
                  "    var loans = pm.response.json().data.loansByStatus;",
                  "    loans.forEach(loan => {",
                  "        pm.expect(loan.status).to.eql('ACTIVE');",
                  "    });",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  loansByStatus(status: ACTIVE) {\n    id\n    amount\n    status\n    monthlyPayment\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "Filter loans by status.\n\nExpected: 2 active loans"
          },
          "response": []
        },
        {
          "name": "12. Loan with User References (Stubs)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Loan has lender and borrower references\", function () {",
                  "    var loan = pm.response.json().data.loan;",
                  "    pm.expect(loan.lender).to.exist;",
                  "    pm.expect(loan.borrower).to.exist;",
                  "    pm.expect(loan.lender.id).to.exist;",
                  "    pm.expect(loan.borrower.id).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  loan(id: \"loan-001\") {\n    id\n    amount\n    lender {\n      id\n    }\n    borrower {\n      id\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "**Federation Concept: Entity References**\n\nLoan references User entities.\n\nLoans service returns stubs (only ID).\n\nWith Apollo Router, full User data would be resolved from Users service."
          },
          "response": []
        },
        {
          "name": "13. Create Loan Request (Mutation)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Loan creation was successful\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.createLoanRequest.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"Loan has calculated fields\", function () {",
                  "    var loan = pm.response.json().data.createLoanRequest.loan;",
                  "    pm.expect(loan.monthlyPayment).to.be.above(0);",
                  "    pm.expect(loan.totalRepayment).to.be.above(0);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "mutation {\n  createLoanRequest(input: {\n    borrowerId: \"user-003\"\n    amount: 35000\n    interestRate: 8.0\n    term: 36\n    purpose: \"Business expansion\"\n  }) {\n    success\n    message\n    loan {\n      id\n      amount\n      interestRate\n      monthlyPayment\n      totalRepayment\n      status\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "Create a new loan request.\n\nCalculates monthly payment and total repayment automatically."
          },
          "response": []
        },
        {
          "name": "14. Fund Loan (Mutation)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Loan funded successfully\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.fundLoan.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"Loan status changed to FUNDED\", function () {",
                  "    var loan = pm.response.json().data.fundLoan.loan;",
                  "    pm.expect(loan.status).to.eql('FUNDED');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "mutation {\n  fundLoan(\n    loanId: \"loan-003\"\n    lenderId: \"user-001\"\n  ) {\n    success\n    message\n    loan {\n      id\n      status\n      lender {\n        id\n      }\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "Fund a pending loan.\n\nChanges status from PENDING to FUNDED."
          },
          "response": []
        },
        {
          "name": "15. Introspection - Loan Type",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Loan type exists\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.data.__type.name).to.eql('Loan');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "graphql",
              "graphql": {
                "query": "{\n  __type(name: \"Loan\") {\n    name\n    fields {\n      name\n      type {\n        name\n        kind\n      }\n    }\n  }\n}",
                "variables": ""
              }
            },
            "url": {
              "raw": "{{LOANS_SERVICE}}",
              "host": [
                "{{LOANS_SERVICE}}"
              ]
            },
            "description": "**Introspection Query**\n\nExplore the Loan type definition in the Loans subgraph."
          },
          "response": []
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "USERS_SERVICE",
      "value": "http://localhost:8081/graphql",
      "type": "string"
    },
    {
      "key": "LOANS_SERVICE",
      "value": "http://localhost:8082/graphql",
      "type": "string"
    },
    {
      "key": "APOLLO_ROUTER",
      "value": "http://localhost:8080/graphql",
      "type": "string",
      "disabled": true
    }
  ]
}
